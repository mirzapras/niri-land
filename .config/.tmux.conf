# Enable mouse mode
set -g mouse on

# ==================================================================
# Clipboard Integration (Wayland + X11)
# ==================================================================

# Copy mode uses vi keys
setw -g mode-keys vi

# Increase scrollback buffer
set -g history-limit 100000

# ==================================================================
# KEYBOARD COPY MODE (vi-style)
# ==================================================================

# Start selection with 'v' (like visual mode in vi)
bind-key -T copy-mode-vi v send-keys -X begin-selection
bind-key -T copy-mode-vi V send-keys -X select-line
bind-key -T copy-mode-vi C-v send-keys -X rectangle-toggle

# Enable external clipboard (required for wl-copy integration)
set -s set-clipboard external

# Default pipe for copies
set -s copy-command "wl-copy"

# =====================
# CLIPBOARD SHENANIGANS
# =====================
# Dual-pipe: Set both primary (middle-click) and clipboard (Ctrl+V/Ctrl+Shift+V)
bind-key -T copy-mode-vi y send-keys -X copy-pipe-and-cancel 'bash -c "tee >(wl-copy --primary) | wl-copy"'
bind-key -T copy-mode-vi Enter send-keys -X copy-pipe-and-cancel 'bash -c "tee >(wl-copy --primary) | wl-copy"'

# Middle-click to yank selection and exit copy-mode (while in copy-mode-vi)
bind-key -T copy-mode-vi MouseDown2Pane send-keys -X copy-pipe-and-cancel 'bash -c "tee >(wl-copy --primary) | wl-copy"'

# Auto-yank selection to both primary and clipboard on drag release, then exit
bind-key -T copy-mode-vi MouseDragEnd1Pane send-keys -X copy-pipe-and-cancel 'bash -c "tee >(wl-copy --primary) | wl-copy"'

# ==================================================================
# Middle-click = paste PRIMARY selection (highlighted text only)
#if-shell "test -n \"$WAYLAND_DISPLAY\"" {
#  bind-key -n MouseDown2Pane run-shell -b "wl-paste --primary 2>/dev/null | tmux load-buffer - && tmux paste-buffer -t '#{pane_id}'"
#}
# Middle-click = paste PRIMARY if set, else CLIPBOARD (unified handling)
if-shell "test -n \"$WAYLAND_DISPLAY\"" {
  bind-key -n MouseDown2Pane run-shell -b "(wl-paste --primary 2>/dev/null || wl-paste) | tmux load-buffer - && tmux paste-buffer -t '#{pane_id}'"
}

# Right-click = paste CLIPBOARD (explicit Ctrl+C)
if-shell "test -n \"$WAYLAND_DISPLAY\"" {
  bind-key -n MouseDown3Pane run-shell -b "wl-paste 2>/dev/null | tmux load-buffer - && tmux paste-buffer -t '#{pane_id}'"
}

# ==================================================================
# FIX NANO CONFLICTS & SCROLLWHEEL SENSITIVITY (Updated and Cleaned)
# ==================================================================

# Wheel up/down: Enter copy mode, then let the terminal handle scrolling events
# (Fixes 50-line scroll issue by removing -u flag)
bind-key -n WheelUpPane   if-shell -F "#{alternate_on}" "send-keys -N 1 Up" "copy-mode -e"
# Consolidated the command onto a single line:
bind-key -n WheelDownPane if-shell -F "#{alternate_on}" "send-keys -N 1 Down" "send-keys -N 1 Down"

# PageUp only enters copy mode when NOT in nano (when pane is at alternate screen)
# Note: Using 'copy-mode -e' for consistency.
bind-key -n PageUp   if-shell -F "#{alternate_on}" "send-keys PageUp" "copy-mode -e"
bind-key -n PageDown if-shell -F "#{alternate_on}" "send-keys PageDown" "send-keys PageDown"

# DON'T bind Ctrl+u globally - it breaks nano's paste
# Use Prefix + P instead to paste from clipboard
if-shell "test -n \"$WAYLAND_DISPLAY\"" {
  # Ensured leading whitespace is a standard character
  bind S-P run "wl-paste --no-newline | tmux load-buffer - && tmux paste-buffer"
}

# DON'T bind PageUp globally - it breaks nano
# PageUp only enters copy mode when NOT in nano (when pane is at alternate screen)
bind-key -n PageUp if-shell -F "#{alternate_on}" "send-keys PageUp" "copy-mode -eu"
bind-key -n PageDown if-shell -F "#{alternate_on}" "send-keys PageDown" "send-keys PageDown"

# Tmux Resurrect (required)
run-shell ~/.tmux/plugins/tmux-resurrect/resurrect.tmux

# Tmux Continuum (auto-save/restore)
run-shell ~/.tmux/plugins/tmux-continuum/continuum.tmux
set -g @continuum-restore 'on'

# ==================================================================
# Quality of Life Improvements
# ==================================================================

# Switch panes without prefix (Alt+arrow keys)
bind -n M-Left select-pane -L
bind -n M-Right select-pane -R
bind -n M-Up select-pane -U
bind -n M-Down select-pane -D

# Split panes using | and - (more intuitive)
bind | split-window -h -c "#{pane_current_path}"
bind - split-window -v -c "#{pane_current_path}"
unbind '"'
unbind %

# Renumber windows automatically (no gaps)
set -g renumber-windows on

# Start windows and panes at 1 (easier keyboard access)
set -g base-index 1
setw -g pane-base-index 1

# ==================================================================
# Gruvbox Dark Theme for tmux
# ==================================================================

# Gruvbox color definitions
gruvbox_bg0="#282828"
gruvbox_bg1="#3c3836"
gruvbox_bg2="#504945"
gruvbox_fg0="#ebdbb2"
gruvbox_fg1="#ebdbb2"
gruvbox_gray="#928374"
gruvbox_red="#fb4934"
gruvbox_green="#b8bb26"
gruvbox_yellow="#fabd2f"
gruvbox_blue="#83a598"
gruvbox_purple="#d3869b"
gruvbox_aqua="#8ec07c"
gruvbox_orange="#fe8019"

# Status bar styling
set -g status-position bottom
set -g status-style bg=$gruvbox_bg1,fg=$gruvbox_fg0

# Status left (session name, window, and pane info)
set -g status-left-length 40
set -g status-left "#[fg=$gruvbox_bg0,bg=$gruvbox_orange,bold] #S #[fg=$gruvbox_orange,bg=$gruvbox_bg1]#[fg=$gruvbox_orange,bg=$gruvbox_bg1,bold] #I:#P "


# Status left (session name and window info)
#set -g status-left-length 40
#set -g status-left "#[fg=$gruvbox_bg0,bg=$gruvbox_yellow,bold] #S #[fg=$gruvbox_yellow,bg=$gruvbox_bg1]"


# Status right (hostname, time, and date)
set -g status-right-length 60
set -g status-right "#[fg=$gruvbox_orange,bg=$gruvbox_bg1]#[fg=$gruvbox_orange,bg=$gruvbox_bg1,bold] %d %b #[fg=$gruvbox_orange,bg=$gruvbox_bg1]#[fg=$gruvbox_bg0,bg=$gruvbox_orange,bold] #H "
#set -g status-right "#[fg=$gruvbox_orange,bg=$gruvbox_bg1]#[fg=$gruvbox_orange,bg=$gruvbox_bg1,bold] %H:%M #[fg=$gruvbox_orange,bg=$gruvbox_bg1]#[fg=$gruvbox_orange,bg=$gruvbox_bg1,bold] %d %b #[fg=$gruvbox_orange,bg=$gruvbox_bg1]#[fg=$gruvbox_bg0,bg=$gruvbox_orange,bold] #H "

# Status right (host and time)
#set -g status-right-length 60
#set -g status-right "#[fg=$gruvbox_blue,bg=$gruvbox_bg1]#[fg=$gruvbox_bg0,bg=$gruvbox_blue,bold] %H:%M #[fg=$gruvbox_aqua,bg=$gruvbox_blue]#[fg=$gruvbox_bg0,bg=$gruvbox_aqua,bold] %d-%b "

# Status bar refresh interval
set -g status-interval 5

# Center the window list
set -g status-justify centre

# Window status format
set -g window-status-format " #I:#W "
set -g window-status-current-format "#[fg=$gruvbox_bg1,bg=$gruvbox_orange,bold] #I:#W #[fg=$gruvbox_orange,bg=$gruvbox_bg1]"

# Pane border colors
set -g pane-border-style fg=$gruvbox_bg2
set -g pane-active-border-style fg=$gruvbox_orange

# Message styling (Prefix + :)
set -g message-style bg=$gruvbox_bg2,fg=$gruvbox_yellow,bold
